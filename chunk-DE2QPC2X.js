import{G as K,H as b}from"./chunk-RUVVEFL4.js";import{B,Ia as q,Oa as z,P as H,Za as G}from"./chunk-3HC7CDKU.js";import{a as C,b as Q,ua as J}from"./chunk-TH5CS6OC.js";import{Da as E,Ha as P,I as y,K as k,Nb as D,O as w,Ob as R,Sb as O,a as $,aa as d,b as V,bc as _,cc as T,dc as A,k as M,l as v,ma as h,nb as F,qa as L,s as x,sb as U,x as S}from"./chunk-6NI24FLG.js";var f=class{constructor(){this.http=h(Q),this.dialog=h(B),this.socketService=h(K),this.projectVM=h(b),this.membershipService=h(q),this.baseUrl=J.baseSyncUrl+"/chat",this.dataUrl="assets/json/chat.json",this.instances$=new v([]),this.instance$=new v({}),this.chats$=new v(null),this.destroy$=new M,this.textForm=new H(null,[]),this.eventListener=[],this.storedFiles=[],this.opened=!0,this.isFileUploading=!1,this.isCommentOpen=!0,this.chatType="chat",this.newChatEmitter=new P,this.initUserToServer(),this.checkInstance()}toggleSidenave(){this.opened=!this.opened}initUserToServer(){console.log("initUserToServer \uD638\uCD9C\uB428, ",this.membershipService.user$.getValue().id);let e=this.membershipService.user$.getValue()?.id;this.membershipService.getUser().pipe(d(this.destroy$)).subscribe(s=>{s.id&&(this.socketService.emitEvent("initUser",{userId:this.membershipService.user$.getValue().id}),this.initListener())})}initListener(){this.listenJoinInstance(),this.listenLeaveInstance(),this.listenLeaveMember(),this.listenCreatePermission(),this.listenCompleteCreatePermission(),this.listenCreatedInstance(),this.listenUpdateInstance(),this.listenCreatedChat(),this.listenDeleteChat(),this.listenCreateReaction(),this.listenDeleteReaction()}connectSocket(e){this.socketService.connect(),this.socketService.emitEvent("joinMultipleInstances",e)}getAllInstances(){return this.instances$.asObservable()}getInstances(){return this.instances$.asObservable()}resetInstance(){console.log("\uC778\uC2A4\uD134\uC2A4 \uCD08\uAE30\uD654"),this.instance$.next({})}listenJoinInstance(){this.projectVM.projects$.pipe(y(e=>e.length>0),w(1)).subscribe(e=>{console.log("\uCD5C\uCD08 \uBC1B\uC544\uC628 \uD504\uB85C\uC81D\uD2B8, ",e);let s="joinInstance",t=n=>{console.log(`${s} \uC774\uBCA4\uD2B8 \uC2E4\uD589\uB428,`,n)};this.addEventListener(s,t),this.socketService.emitEvent(s,{userId:this.membershipService.user$.getValue().id,chatInstances:e})})}listenLeaveInstance(){let e="leaveInstance",s=t=>{console.log(`${e} \uC774\uBCA4\uD2B8 \uC2E4\uD589\uB428, `,t);let n=this.instance$.getValue().id;t.projectId===n&&(this.instance$.next({}),this.projectVM.projectMembers$.next([]));let i=this.projectVM.projects$.getValue().filter(c=>c.id!==t.projectId);this.projectVM.projects$.next([...i])};this.addEventListener(e,s)}listenLeaveMember(){let e="leaveMember",s=t=>{console.log(`${e} \uC774\uBCA4\uD2B8 \uC2E4\uD589\uB428, `,t);let n=this.instance$.getValue().id;if(t.projectId===n){let i=this.projectVM.projectMembers$.getValue().filter(c=>c.id!==t.userId);this.projectVM.projectMembers$.next([...i])}};this.addEventListener(e,s)}listenCreatePermission(){let e="createPermission",s=t=>{console.log(`${e} \uC774\uBCA4\uD2B8 \uC2E4\uD589\uB428, `,t);let{message:n,result:i}=t,{project:c,members:l,permissions:r}=i,a=this.projectVM.projects$.getValue();a.push(c),this.projectVM.projects$.next([...a])};this.addEventListener(e,s)}listenCompleteCreatePermission(){let e="completeCreatePermission",s=t=>{console.log(`${e} \uC774\uBCA4\uD2B8 \uC2E4\uD589\uB428`);let{message:n,result:i}=t,{members:c,permissions:l}=i,r=this.projectVM.projectMembers$.getValue();this.projectVM.projectMembers$.next([...r,...c]),this.projectVM?.dialogRef.close(),this.projectVM?.subscription.unsubscribe()};this.addEventListener(e,s)}listenCreatedInstance(){console.log("\uC778\uC2A4\uD134\uC2A4 \uC0DD\uC131 \uB4E3\uB294 \uC911 ------");let e="createInstance",s=t=>{console.log(`${e} \uC774\uBCA4\uD2B8 \uC2E4\uD589\uB428,`,t);let n=this.projectVM.projects$.getValue();n.push(t.project),this.projectVM.projects$.next([...n])};this.addEventListener(e,s)}listenUpdateInstance(){let e="updateInstance",s=t=>{console.log(`${e} \uC774\uBCA4\uD2B8 \uC2E4\uD589\uB428, `,t);let n=t.result,i=this.projectVM.projects$.getValue(),c=i.find(r=>r.id===n.id);if(!c){console.log("\uCC3E\uC740 \uC778\uC2A4\uD134\uC2A4 \uC5C6\uC74C, ",c);return}c.name=n.name,c.description=n.description,console.log("\uC5C5\uB370\uC774\uD2B8\uB41C \uC778\uC2A4\uD134\uC2A4, ",c),console.log("\uC5C5\uB370\uC774\uD2B8\uB41C \uC778\uC2A4\uD134\uC2A4 \uBC30\uC5F4, ",i),this.projectVM.projects$.next([...i]),this.instance$.getValue().id===n.id&&this.instance$.next($({},c))};this.addEventListener(e,s)}listenCreatedChat(){console.log("\uCC44\uD305 \uB4E3\uAE30\u3161\u3161\u3161\u3161\u3161\u3161\u3161\u3161\u3161");let e="createChat",s=t=>{if(console.log("\uD604\uC7AC \uCC57 \uC778\uC2A4\uD134\uC2A4, ",this.instance$.getValue()),console.log("\uCC44\uD305 \uC0DD\uC131\uB428, ",t),t.instanceId!==this.instance$.getValue().id){console.log("\uB2E4\uB978 \uC778\uC2A4\uD134\uC2A4");return}let n=this.chats$.getValue()??[],i=t.chat;i.commentCount=0,n.push(i),this.chats$.next([...n]),console.log("\uCC44\uD305 \uB370\uC774\uD130, ",t);let c=t?.chat?.user?.id===this.membershipService.user$.getValue().id;this.newChatEmitter.emit(c)};this.addEventListener(e,s)}listenDeleteChat(){let e="deleteChat",s=t=>{console.log("\uCC44\uD305 \uC81C\uAC70 \uC751\uB2F5, ",t);let n=this.instance$.getValue(),{result:i,instanceId:c,chatId:l}=t;if(i.affected===0||n.id!==c)return;console.log("\uCC44\uD305 \uC81C\uAC70");let r=this.chats$.getValue();if(!r)return;let a=r.filter(o=>o.chatId!==l);this.chats$.next([...a])};this.addEventListener(e,s)}listenCreateReaction(){let e="createReaction",s=t=>{console.log(`${e} \uC774\uBCA4\uD2B8 \uBC1C\uC0DD, `,t);let{chatId:n,instanceId:i,result:c}=t,l=this.instance$.getValue().id;if(i!==l)return;let r=this.chats$.getValue();if(!r)return;let a=r.findIndex(I=>I.chatId===n);if(a<0)return;let o=r[a];o.reactions||(o.reactions=[]);let p=o.reactions;p.push(c);let m=V($({},o),{reactions:[...p]}),j=[...r.slice(0,a),m,...r.slice(a+1)];this.chats$.next(j)};this.addEventListener(e,s)}listenDeleteReaction(){let e="deleteReaction",s=t=>{console.log(`${e} \uC774\uBCA4\uD2B8 \uBC1C\uC0DD, `,t);let{chatId:n,instanceId:i,userId:c,emoji:l,result:r}=t,a=this.instance$.getValue().id;if(i!==a)return;let o=this.chats$.getValue();if(!o)return;let p=o.findIndex(g=>g.chatId===n);if(p<0)return;let m=o[p],j=m.reactions.filter(g=>g.user.id!==c||g.emoji!==l),I=V($({},m),{reactions:[...j]}),N=[...o.slice(0,p),I,...o.slice(p+1)];this.chats$.next([...N])};this.addEventListener(e,s)}onSubmit(){this.nullCheck()||this.createChat()}createChatParam(){return{chatId:G(),date:new Date,user:this.membershipService.user$.getValue(),chatText:"",chatData:[...this.storedFiles],conversationId:this.instance$.getValue().id,reactions:[]}}addEventListener(e,s){if(this.eventListener.some(n=>n.key===e)){console.log("\uC18C\uCF13 \uC774\uBCA4\uD2B8 \uC911\uBCF5\uC73C\uB85C \uCDE8\uC18C");return}console.log("\uC774\uBCA4\uD2B8 \uB9AC\uC2A4\uB108 \uB4F1\uB85D");let t=this.socketService.onEvent(e).pipe().subscribe(n=>{s(n)});this.eventListener.push({key:e,value:t})}setInstance(e){console.log(`set ${e}`),this.chats$.next([]),this.instance$.next(this.projectVM.projects$.getValue().find(s=>s.id===e)??{}),this.projectVM.selectedProject$.next(this.projectVM.projects$.getValue().find(s=>s.id===e)??{})}checkInstance(){this.instance$.pipe(d(this.destroy$)).subscribe(e=>{this.getChatsFromServer(e.id),this.getMembersFromServer(e.id)})}getChatsFromServer(e){let s=new C().set("conversationId",e);this.http.get(this.baseUrl+"/chats",{params:s}).pipe(d(this.destroy$),k(t=>(console.log("\uCC44\uD305 \uAC00\uC838\uC624\uB294 \uC911 \uC5D0\uB7EC \uBC1C\uC0DD, ",t),x()))).subscribe({next:t=>{console.log("\uCC57 \uB370\uC774\uD130 \uAC00\uC838\uC634, ",t),this.chats$.next([...t])},complete:()=>{console.log("http \uCEF4\uD50C\uB9AC\uD2B8")}})}getMembersFromServer(e){let s=new C().set("conversationId",e);this.http.get(this.baseUrl+"/members",{params:s}).pipe(d(this.destroy$)).subscribe(t=>{console.log("\uBA64\uBC84 \uC870\uD68C \uACB0\uACFC",t),this.projectVM.projectMembers$.next(t.members)})}getChat(e){return this.chats$.asObservable().pipe(S(s=>s?.find(t=>t.chatId===e)??{}))}getChats(){return this.chats$.asObservable()}getChatsSync(){return this.chats$.getValue()}setChats(e){this.chats$.next([...e])}resetChats(){this.chats$.next([])}getInstance(){return this.instance$.asObservable()}getInstanceSync(){return this.instance$.getValue()}nullCheck(){return!this.textForm.value&&this.storedFiles.length==0}destroy(){console.log("chatVM destroy \uD638\uCD9C000000000000000000000"),this.socketService.emitEvent("disconnectUser",{userId:this.membershipService.user$.getValue().id}),this.socketService.disconnect(),this.destroy$.next(),this.destroy$.complete()}};var W=["container"],$e=(()=>{class u extends z{constructor(){super(...arguments),this.projectVM=h(b),this.chatVM=h(f)}ngOnInit(){this.data=this.projectVM.containerData,this.container.createComponent(this.data.type).setInput("data",this.data.data),this.projectVM.getProjectFromServer()}ngAfterViewInit(){this.projectVM.setContainer(this.container)}static{this.\u0275fac=(()=>{let s;return function(n){return(s||(s=E(u)))(n||u)}})()}static{this.\u0275cmp=L({type:u,selectors:[["app-project-layout"]],viewQuery:function(t,n){if(t&1&&_(W,7,F),t&2){let i;T(i=A())&&(n.container=i.first)}},features:[U],decls:4,vars:0,consts:[["container",""],[1,"container"],[1,"container-content"],[1,"content-item"]],template:function(t,n){t&1&&(D(0,"div",1)(1,"div",2),O(2,3,0),R()())},styles:["[_nghost-%COMP%]{flex:1}.container[_ngcontent-%COMP%]{margin:0;width:100%;height:100%;display:flex;flex-direction:row;flex:1;padding-right:20px}.container-content[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;background-color:#fff}.content-item[_ngcontent-%COMP%]{flex:1}"]})}}return u})();export{f as a,$e as b};
